<!doctype html>
<html>
<head>
<title>logzui</title>
<link rel="icon" href="/favicon.ico" type="image/gif">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.8/semantic.min.css">
</head><body>

<style>
.duration {
  font-size: .85714286em;
  margin: 0 0 0 .3em;
  color: rgba(0,0,0,.4);
}
.reset-zone {
  cursor: pointer;
}
.undo {
  color: #8BC34A;
  float: right;
}
</style>

<div class="ui main container" style="margin-top:1em">

  <script type="text/html" id="loader_tpl">
    <div class="ui active inverted dimmer">
      <div class="ui large text loader">Loading</div>
    </div>
  </script>

  <div class="ui form">
    <div class="fields">
        <div class="four wide field">
          <select id="param-index" class="ui fluid dropdown refresh">
          </select>
          <script type="text/html" id="indexes_tpl">
            <% for ( var i = 0; i < obj.indexes.length; i++ )  { %>
              <option value="<%= obj.indexes[i] %>"><%= obj.indexes[i] %></option>
            <% } %>
          </script>
        </div>
        <div class="ten wide field">
          <div class="field">
            <input type="text" placeholder="search..." value="*" id="param-query" class="refresh">
          </div>
        </div>
        <div class="two wide field">
          <select id="param-since" class="ui fluid dropdown refresh">
            <option value="10">10s</option>
            <option value="60" selected="selected">1m</option>
            <option value="600">10m</option>
            <option value="3600">1h</option>
            <option value="7200">2h</option>
            <option value="21600">6h</option>
            <option value="43200">12h</option>
            <option value="86400">1d</option>
            <option value="172800">2d</option>
            <option value="604800">7d</option>
          </select>
      </div>
    </div>
  </div>

  <br>

  <div id="logs" class="ui two column stackable grid">
  </div>

  <script type="text/html" id="logs_tpl">
    <div class="four wide column">
      <!-- Aggregs -->
      <% for ( var aggregationKey in obj.aggregations )  { %>
        <% if (obj.aggregations[aggregationKey].buckets.length > 0)  { %>
        <div class="ui vertical menu">
          <div class="item reset-zone">
            <span class="reset" key="<%= aggregationKey %>">
              <%= aggregationKey %>
              <% if (obj.filters.term[aggregationKey]) { %>
              <i class="undo icon"></i>
              <% } %>
            </span>
            <% for ( var i = 0; i < obj.aggregations[aggregationKey].buckets.length; i++ )  { %>
              <div class="menu">
                <a class="item filter"
                  key="<%= aggregationKey %>"
                  name="<%= obj.aggregations[aggregationKey].buckets[i].key %>">
                  <%= obj.aggregations[aggregationKey].buckets[i].key %>
                  <div class="ui label">
                    <%= obj.aggregations[aggregationKey].buckets[i].doc_count %>
                  </div>
                </a>
              </div>
            <% } %>
          </div>
        </div>
        <% } %>
      <% } %>
    </div>

    <div class="twelve wide column">
      <div class="ui feed">
        <% if (obj.hits.hits.length == 0)  { %>
        <div>
          No results found.
        </div>
        <div class="ui segment">
          <a href="http://thecatapi.com">
            <img class="ui centered medium image" target="_cat"
              src="http://thecatapi.com/api/images/get?format=src&type=gif">
          </a>
        </div>
        <% } else { %>
          <div>
            <%= obj.hits.total %> results <span class="duration">in <%= obj.duration %>s<span>
          </div>
          <% for ( var i = 0; i < obj.hits.hits.length; i++ )  { %>
            <div class="event">
              <div class="content">
                <div class="summary">
                  <!-- summary/status -->
                  <% if (obj.hits.hits[i]._source.status == 'OK') {
                    color = 'teal'
                  } else {
                    color = 'red'
                  } %>
                  <a class="ui <%= color %> horizontal label" style="min-width:60px; text-align: center">
                    <%= obj.hits.hits[i]._source.status %>
                  </a>
                  <!-- summary/title -->
                  <a><%= obj.hits.hits[i]._source['long_cmd'] %></a>
                  from
                  <a><%= obj.hits.hits[i]._source.source %></a>
                  <!-- summary/fromNow -->
                  <div class="date" title="<%= obj.hits.hits[i].timestamp %>">
                    <%= obj.hits.hits[i].fromNow %>
                  </div>
                </div>
                <div class="extra images">
                  <div class="ui short message">
                    <!-- message -->
                    <%= obj.hits.hits[i]._source.message %>
                  </div>
                  <div class="ui full message" style="display:none">
                    <!-- message -->
                    <%= obj.hits.hits[i]._source.fullMessage %>
                  </div>
                </div>
              </div>
            </div>
          <% } %>

        <% } %>
      </div>
    </div>
  </script>

</div>

<script src="https://thbkrkr.github.io/s.js/dist/s.2.db65b41.js"></script><script>

function fromNow(timestamp) {
  var hours = 0
  return moment.unix(timestamp).add(hours, 'hours').fromNow()
}

function cleanTag(tag) {
  return tag
    .replace(/\[[0-9]*\]:/, '')
    .replace(/\/[0-9a-z]*$/, '')
    .replace(/docker\//, '')
}

function cleanMessage(message, query) {
  message = message
    .replace(/\[#[0-9]*\[[0-9]*minfo#[0-9]*\[0m\]/g, '')
    .replace(/|#[0-9]*\[[0-9]*;[0-9]*m/g, '')
    .replace(/|#[0-9]*\[0m|/g, '')

  if (message.indexOf('level=') != -1) {
    message = message
      .replace(/time="[0-9\-:TZ]*"/, '')
      .replace(/level=info/, 'level=<span style="color:#009688">info</span>')
      .replace(/level=warning/, 'level=<span style="color:#FF9800">warning</span>')
      .replace(/level=error/, 'level=<span style="color:#F44336">error</span>')
  }

  if (query != '*') {
    query = query.replace(/\*/g)
    var queryRe = new RegExp(query, "gi");
    message = message
      .replace(queryRe, '<b style="color:#E91E63">'+query+'</b>')
  }

  return message
}

function transform(results, paramQuery) {
  var hits = results.hits.hits

  // Inject fromNow using the _source.timestamp field
  for (var i = hits.length - 1; i >= 0; i--) {
    results.hits.hits[i].fromNow = fromNow(hits[i]._source.timestamp)

    // FIXME!
    if (hits[i]._source.tag) {
      results.hits.hits[i]._source.tag = cleanTag(hits[i]._source.tag)
    }
    if (hits[i]._source.message) {
      message = cleanMessage(hits[i]._source.message, paramQuery)
      results.hits.hits[i]._source.fullMessage = message
      lines = message.split('<br>')
      results.hits.hits[i]._source.message = lines[lines.length-2]
    }
  }

  // Clean aggreation buckets key
  for (var aggregationKey in results.aggregations) {
    var buckets = results.aggregations[aggregationKey].buckets
    for (var i = buckets.length - 1; i >= 0; i--) {
      results.aggregations[aggregationKey].buckets[i].key = cleanTag(buckets[i].key)
    }
  }
  return results
}

// ---

function error() {
  $('#logs').html(`<br><br>
    <div class="five wide column">
      Oops. An error occured.
    </div>
  `)
}

function config(onSuccess) {
  // Get and display indexes select
  $get('/s/config/config.json', function(config) {
    $('#param-index').append($tpl('indexes_tpl', config))
    onSuccess(config)
  })
}

function since(duration) {
  return moment().subtract(duration, 'seconds').unix()
}

function search(request) {
  // Display loader
  $('#logs').append($tpl('loader_tpl', {}))

  // Get and display search results
  var start = new Date().getTime()
  var paramQuery = $lsGet('query')
  if (paramQuery == '') paramQuery = '*'

  // Inject filters in the request
  var filters = $lsGet('filters')
  if (!filters) {
    filters = { term: {} }
  } else {
    for ( var field in filters.term ) {
      var value = filters.term[field]
      filter = { term: {} }
      filter.term[field] = value
      request.query.bool.must.push(filter)
    }
  }

  $post('/api/search', {
    var: {
      index: $lsGet('index'),
      query: paramQuery,
      since: since($lsGet('since')),
    },
    request: request
  }, function(results) {
    // Fail fast
    if (!results.hits) {
      error(); return
    }

    var obj = transform(results, paramQuery)
    obj.duration = (new Date().getTime() - start) / 1000

    obj.filters = filters

    $('#logs').html($tpl('logs_tpl', obj))

    // Toggle message on click - lock/unlock toggle by pressing 'e'
    var expandMode = true
    $('.message').css('cursor', 'all-scroll')
    $('body').bind('keypress', function(event) {
        if (event.which == 101) { // e
          if (expandMode) {
            $('.message').css('cursor', '')
          } else {
            $('.message').css('cursor', 'all-scroll')
          }
          expandMode = !expandMode
        }
    })
    $('.short').on('click', function() {
      if (expandMode) {
        $(this).hide()
        $(this).parents('.extra').children('.full').show()
      }
    })
    $('.full').on('click', function() {
      if (expandMode) {
        $(this).hide()
        $(this).parents('.extra').children('.short').show()
      }
    })

    // Aggregs filtering
    $('.filter').on('click', function(el) {
      var filters = $lsGet('filters')
      if (!filters) filters = { term: {} }
      filters.term[$(this).attr('key')] = $(this).attr('name')
      $lsSet('filters', filters)
      refresh()
    })

    $('.reset').on('click', function(el) {
      var filters = $lsGet('filters')
      //if (!filters) filters = { term: {} }
      delete filters.term[$(this).attr('key')]
      $lsSet('filters', filters)
      refresh()
    })

  }, function(err) {
    error()
  })
}

function refresh(init) {
  config(function(c) {
    if (init === true) {
      if ($lsGet('index')) {
        $('#param-index').val($lsGet('index'))
        $('#param-query').val($lsGet('query'))
        $('#param-since').val($lsGet('since'))
      }
    }
    $lsSet('index', $('#param-index').val())
    $lsSet('query', $('#param-query').val())
    $lsSet('since', $('#param-since').val())

    search(c.request)
  })
}

function initListeners() {
  $('.refresh').on('change', refresh)
}

initListeners()
refresh(true)

//setInterval(1000, refresh)

</script></body></html>
